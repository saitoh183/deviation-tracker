<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Once Human â€” Deviation Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ===== RESET & BASE ===== */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg0:#0d1117;--bg1:#1a1a2e;--bg2:#16213e;--bg3:#0f3460;
  --accent:#00d4ff;--accent2:#00b4d8;--accent-dim:#0077a8;
  --text:#e0e6f0;--text-dim:#8899b0;--text-muted:#4a5568;
  --row-alt:rgba(0,180,216,0.04);
  --border:#1e3a5f;--border-light:rgba(0,212,255,0.15);
  --neg:#ff6b35;
  --green:#4ade80;--lime:#a3e635;--yellow:#facc15;--orange:#fb923c;--red:#f87171;
  --gold:#ffd700;
  --toggle-on:#00d4ff;--toggle-off:#2d3748;
  --shadow:0 4px 24px rgba(0,0,0,0.6);
  --radius:6px;
  font-family:'Exo 2',sans-serif;
}
html{background:var(--bg0);color:var(--text);min-height:100vh}
body{min-height:100vh;background:linear-gradient(160deg,var(--bg0) 0%,var(--bg1) 50%,var(--bg0) 100%)}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg1)}
::-webkit-scrollbar-thumb{background:var(--accent-dim);border-radius:3px}

/* ===== HEADER ===== */
.app-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;
  background:linear-gradient(90deg,var(--bg1),var(--bg2));
  border-bottom:1px solid var(--border-light);
  position:sticky;top:0;z-index:200;
}
.app-title{font-size:1.4rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);text-shadow:0 0 20px rgba(0,212,255,0.4)}
.app-title span{color:var(--text-dim);font-weight:300}
.gear-btn{background:none;border:1px solid var(--border-light);border-radius:var(--radius);color:var(--text-dim);font-size:1.3rem;padding:6px 10px;transition:all .2s}
.gear-btn:hover{color:var(--accent);border-color:var(--accent);background:rgba(0,212,255,0.08)}

/* ===== TABS ===== */
.tab-bar{display:flex;gap:4px;padding:10px 20px 0;background:var(--bg1);border-bottom:1px solid var(--border)}
.tab-btn{padding:9px 22px;font-weight:600;font-size:.95rem;background:none;border:1px solid transparent;border-bottom:none;color:var(--text-dim);border-radius:var(--radius) var(--radius) 0 0;transition:all .2s;letter-spacing:.5px}
.tab-btn:hover{color:var(--text);background:rgba(255,255,255,0.04)}
.tab-btn.active{color:var(--accent);background:var(--bg0);border-color:var(--border-light);text-shadow:0 0 12px rgba(0,212,255,0.3)}
.tab-content{display:none;padding:16px 20px}
.tab-content.active{display:block}

/* ===== FILTER BAR ===== */
.filter-bar{background:var(--bg1);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:flex-end;gap:10px}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-group label{font-size:.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px}
.filter-bar select,.filter-bar input[type=text]{background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:5px 8px;font-size:.82rem;min-width:110px}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent)}
.filter-actions{display:flex;gap:8px;align-items:flex-end;margin-left:auto;flex-wrap:wrap}
.row-count{font-size:.78rem;color:var(--text-dim);align-self:center;white-space:nowrap}

/* ===== BUTTONS ===== */
.btn{padding:6px 14px;border-radius:var(--radius);border:none;font-weight:600;font-size:.82rem;letter-spacing:.5px;transition:all .2s;cursor:pointer;white-space:nowrap}
.btn-primary{background:var(--accent-dim);color:#fff}
.btn-primary:hover{background:var(--accent2);box-shadow:0 0 12px rgba(0,212,255,0.3)}
.btn-secondary{background:var(--bg3);border:1px solid var(--border-light);color:var(--text-dim)}
.btn-secondary:hover{color:var(--text);border-color:var(--accent)}
.btn-danger{background:#7f1d1d;border:1px solid #991b1b;color:#fca5a5}
.btn-danger:hover{background:#991b1b}
.btn-sm{padding:4px 10px;font-size:.76rem}

/* ===== TOOLBAR ===== */
.controls-bar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px}
.btn-group{display:flex;flex-wrap:wrap;gap:6px;align-items:center}

/* ===== TABLE ===== */
.table-wrap{overflow-x:auto;width:100%;border:1px solid var(--border);border-radius:var(--radius)}
table{table-layout:fixed;width:max-content;min-width:100%;border-collapse:collapse;font-size:.83rem}
thead tr{background:var(--bg2);position:sticky;top:0;z-index:10}
th{padding:9px 8px;text-align:left;font-weight:600;color:var(--accent);font-size:.75rem;text-transform:uppercase;letter-spacing:.7px;white-space:nowrap;border-bottom:2px solid var(--border-light);cursor:pointer;user-select:none;overflow:hidden}
th:hover{color:#fff;background:rgba(0,212,255,0.06)}
th.sort-asc::after{content:' â–²';opacity:.8}
th.sort-desc::after{content:' â–¼';opacity:.8}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s}
tbody tr:nth-child(even){background:var(--row-alt)}
tbody tr:hover{background:rgba(0,212,255,0.07)}
td{padding:5px 6px;vertical-align:middle;overflow:hidden}
.empty-row td{text-align:center;color:var(--text-dim);padding:30px;font-style:italic;overflow:visible}

/* ===== TABLE INPUTS ===== */
td select,td input[type=text]{background:transparent;border:1px solid transparent;border-radius:4px;color:var(--text);padding:3px 5px;width:100%;display:block;box-sizing:border-box}
td select:focus,td input[type=text]:focus{outline:none;border-color:var(--accent);background:var(--bg2)}
td select:hover,td input[type=text]:hover{border-color:var(--border-light)}
td select option{background:var(--bg2)}

/* ===== TRAIT CELLS ===== */
.trait-cell select{font-size:.78rem;color:var(--text)}
.trait-cell select.neg-trait{color:var(--neg)}

/* ===== SHARED TOOLTIP (fixed, body-level) ===== */
#shared-tooltip{position:fixed;z-index:9999;min-width:220px;max-width:300px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);pointer-events:none;display:none}
.tooltip-header{padding:8px 10px;font-weight:700;font-size:.82rem;border-radius:var(--radius) var(--radius) 0 0}
.tooltip-header.pos{background:linear-gradient(90deg,#064e3b,#065f46);color:var(--green);border-bottom:1px solid #065f46}
.tooltip-header.neg{background:linear-gradient(90deg,#7c2d12,#9a3412);color:var(--neg);border-bottom:1px solid #9a3412}
.tooltip-body{padding:8px 10px;font-size:.78rem;color:var(--text);line-height:1.45}

/* ===== TOGGLE ===== */
.toggle-wrap{text-align:center;padding:3px 0}
.toggle{position:relative;display:inline-block;width:36px;height:20px;cursor:pointer;vertical-align:middle;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle-slider{position:absolute;top:0;right:0;bottom:0;left:0;background:var(--toggle-off);border-radius:20px;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;left:3px;top:3px;transition:.2s}
.toggle input:checked~.toggle-slider{background:var(--toggle-on)}
.toggle input:checked~.toggle-slider::before{transform:translateX(16px)}

/* ===== DELETE BTN ===== */
.del-btn{background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-muted);padding:3px 8px;font-size:.9rem;transition:all .15s}
.del-btn:hover{background:#7f1d1d;border-color:#ef4444;color:#fca5a5}

/* ===== FUSION MATERIALS ===== */
.fm-header{margin-bottom:4px}
.fm-header h2{font-size:1.1rem;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase}
.fm-header p{font-size:.82rem;color:var(--text-dim);margin-top:2px}
.fm-controls{display:flex;gap:8px;margin:12px 0}
.fm-list{display:flex;flex-direction:column;gap:6px}
.fm-empty{color:var(--text-dim);font-style:italic;font-size:.88rem;padding:20px 0}
.fm-row{display:flex;align-items:center;gap:8px;background:var(--bg1);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;transition:background .15s}
.fm-row:hover{background:var(--bg2)}
.drag-handle{color:var(--text-muted);cursor:grab;font-size:1rem;padding:0 4px;flex-shrink:0;user-select:none}
.drag-handle:active{cursor:grabbing}
.fm-row.drag-over{border-color:var(--accent);background:rgba(0,212,255,0.08)}
.fm-row.dragging{opacity:.4}
.fm-name{flex:2;min-width:120px}
.fm-qty{width:70px}
.fm-notes{flex:3;min-width:120px}
.fm-input{background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:6px 8px;width:100%;font-size:.85rem}
.fm-input:focus{outline:none;border-color:var(--accent)}

/* ===== SETTINGS SLIDE-IN ===== */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:900;backdrop-filter:blur(2px)}
.overlay.open{display:flex;align-items:flex-start;justify-content:flex-end}
.settings-panel{width:340px;min-height:100vh;background:var(--bg1);border-left:1px solid var(--border-light);padding:20px;display:flex;flex-direction:column;gap:16px;animation:slideIn .22s ease;box-shadow:-8px 0 40px rgba(0,0,0,.5);overflow-y:auto}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
.settings-header{display:flex;align-items:center;justify-content:space-between}
.settings-header h2{font-size:1rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px}
.close-btn{background:none;border:none;color:var(--text-dim);font-size:1.4rem;line-height:1;padding:2px 6px}
.close-btn:hover{color:var(--text)}
.settings-section{border-top:1px solid var(--border);padding-top:14px}
.settings-section h3{font-size:.78rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:10px}
.char-add-row{display:flex;gap:6px;margin-bottom:10px}
.char-add-row input{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:7px 10px;font-size:.85rem}
.char-add-row input:focus{outline:none;border-color:var(--accent)}
.char-list{display:flex;flex-direction:column;gap:4px}
.char-item{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-size:.88rem}
.char-del{background:none;border:none;color:var(--text-muted);font-size:1rem;padding:0 4px}
.char-del:hover{color:var(--neg)}
.char-empty{color:var(--text-dim);font-style:italic;font-size:.82rem;padding:6px 0}
.settings-note{font-size:.75rem;color:var(--text-muted);line-height:1.5;border-top:1px solid var(--border);padding-top:10px}
.settings-btn-list{display:flex;flex-direction:column;gap:6px}

/* ===== MODALS (shared) ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1000;align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:var(--bg1);border:1px solid var(--accent);border-radius:8px;box-shadow:var(--shadow);width:100%;display:flex;flex-direction:column;max-height:90vh}
.modal-sm{max-width:400px}
.modal-lg{max-width:620px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-header h3{font-size:1rem;font-weight:700;color:var(--accent);letter-spacing:.5px}
.modal-body{padding:16px 18px;overflow-y:auto;flex:1}
.modal-footer{padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-shrink:0}

/* ===== MODAL INNER TABS ===== */
.modal-tabs{display:flex;gap:2px;padding:10px 18px 0;background:var(--bg2);flex-shrink:0}
.modal-tab-btn{padding:7px 18px;font-weight:600;font-size:.85rem;background:none;border:1px solid transparent;border-bottom:none;color:var(--text-dim);border-radius:4px 4px 0 0;transition:all .18s;cursor:pointer}
.modal-tab-btn:hover{color:var(--text)}
.modal-tab-btn.active{color:var(--accent);background:var(--bg1);border-color:var(--border-light)}
.modal-tab-pane{display:none}
.modal-tab-pane.active{display:block}

/* ===== FORM ELEMENTS IN MODALS ===== */
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:.78rem;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);margin-bottom:5px;font-weight:600}
.form-input{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:8px 10px;font-size:.88rem}
.form-input:focus{outline:none;border-color:var(--accent)}
.form-textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:8px 10px;font-size:.88rem;min-height:80px;resize:vertical;line-height:1.45}
.form-textarea:focus{outline:none;border-color:var(--accent)}
.radio-group{display:flex;gap:16px}
.radio-group label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.88rem;color:var(--text)}
.radio-group input[type=radio]{accent-color:var(--accent)}

/* ===== DEV/TRAIT LISTS IN MODALS ===== */
.mgr-list{max-height:52vh;overflow-y:auto;border:1px solid var(--border);border-radius:4px;background:var(--bg2)}
.mgr-section-head{padding:6px 10px;font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);background:var(--bg3);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:2}
.mgr-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid var(--border);font-size:.85rem}
.mgr-item:last-child{border-bottom:none}
.mgr-item:hover{background:rgba(0,212,255,0.04)}
.mgr-item-name{flex:1;color:var(--text)}
.mgr-item-name.neg-name{color:var(--neg)}
.lock-icon{color:var(--text-muted);font-size:.9rem;cursor:help;flex-shrink:0}
.mgr-del-btn{background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-muted);padding:2px 7px;font-size:.85rem;flex-shrink:0;transition:all .15s}
.mgr-del-btn:hover{background:#7f1d1d;border-color:#ef4444;color:#fca5a5}
.mgr-search{width:100%;background:var(--bg2);border:1px solid var(--border);border-bottom:2px solid var(--border-light);border-radius:4px 4px 0 0;color:var(--text);padding:8px 10px;font-size:.85rem}
.mgr-search:focus{outline:none;border-color:var(--accent)}
.mgr-empty{padding:20px;text-align:center;color:var(--text-muted);font-style:italic;font-size:.85rem}

/* ===== APPLIES-TO CHECKLIST ===== */
.dev-checklist{max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;background:var(--bg2);padding:4px 0}
.dev-check-item{display:flex;align-items:center;gap:8px;padding:5px 10px;font-size:.85rem;cursor:pointer}
.dev-check-item:hover{background:rgba(0,212,255,0.06)}
.dev-check-item input{accent-color:var(--accent);cursor:pointer}
.dev-check-item.hidden{display:none}
.all-devs-wrap{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:.88rem;color:var(--text)}
.all-devs-wrap input{accent-color:var(--accent)}

/* ===== FLASH MESSAGE ===== */
.flash-msg{font-size:.82rem;padding:6px 0;min-height:24px;color:var(--green);font-weight:600;opacity:0;transition:opacity .3s}
.flash-msg.show{opacity:1}
.flash-msg.err{color:var(--neg)}

/* ===== SEARCH IN REMOVE TAB ===== */
.remove-search-wrap{margin-bottom:8px}

/* ===== CONFIRM MODAL ===== */
.modal p.modal-msg{font-size:.88rem;color:var(--text-dim);margin-bottom:0;line-height:1.5}

/* ===== FOOTER ===== */
footer{text-align:center;padding:16px;font-size:.75rem;color:var(--text-muted);border-top:1px solid var(--border);margin-top:20px}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .app-header{padding:10px 12px}
  .tab-content{padding:10px 12px}
  .filter-bar{flex-direction:column}
  .filter-actions{margin-left:0}
  .controls-bar{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div class="app-title">âš¡ Once Human <span>/ Deviation Tracker</span></div>
  <button class="gear-btn" onclick="openSettings()" title="Settings">âš™</button>
</header>

<!-- MAIN TABS -->
<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('deviations',this)">âš” Deviations</button>
  <button class="tab-btn" onclick="switchTab('fusion',this)">ðŸ§ª Fusion Materials</button>
</nav>

<!-- ======================================================= -->
<!-- TAB 1: DEVIATIONS                                        -->
<!-- ======================================================= -->
<div id="tab-deviations" class="tab-content active">

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>Character</label>
      <select id="fChar" onchange="applyFilters()"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>Variant</label>
      <select id="fVariant" onchange="applyFilters()"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>Deviation</label>
      <input id="fDeviation" type="text" placeholder="Searchâ€¦" oninput="applyFilters()">
    </div>
    <div class="filter-group">
      <label>Fusion</label>
      <select id="fFusion" onchange="applyFilters()">
        <option value="">All</option><option value="1">Yes</option><option value="0">No</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Locked</label>
      <select id="fLocked" onchange="applyFilters()">
        <option value="">All</option><option value="1">Yes</option><option value="0">No</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Skill Level</label>
      <select id="fSkill" onchange="applyFilters()">
        <option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Activity Level</label>
      <select id="fActivity" onchange="applyFilters()">
        <option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </div>
    <div class="filter-actions">
      <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
      <span class="row-count" id="rowCount">Showing 0 of 0 deviations</span>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="controls-bar">
    <div class="btn-group">
      <button class="btn btn-primary" onclick="addDeviationRow()">+ Add Deviation</button>
      <button class="btn btn-secondary" onclick="openManageDeviations()">âš¡ Manage Deviations</button>
      <button class="btn btn-secondary" onclick="openManageTraits()">âœ¨ Manage Traits</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-secondary" onclick="saveConfig()">ðŸ’¾ Save Config</button>
      <button class="btn btn-secondary" onclick="triggerLoadConfig()">ðŸ“‚ Load Config</button>
      <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
      <button class="btn btn-danger" onclick="confirmClearAll()">ðŸ—‘ Clear All Data</button>
    </div>
  </div>
  <input type="file" id="configFileInput" accept=".json" style="display:none" onchange="handleConfigLoad(event)">

  <!-- Table -->
  <div class="table-wrap">
    <table id="deviationTable">
      <colgroup>
        <col style="width:120px"><!-- 1 Character -->
        <col style="width:155px"><!-- 2 Deviation Name -->
        <col style="width:130px"><!-- 3 Variant -->
        <col style="width:155px"><!-- 4 Trait 1 -->
        <col style="width:155px"><!-- 5 Trait 2 -->
        <col style="width:155px"><!-- 6 Trait 3 -->
        <col style="width:155px"><!-- 7 Trait 4 -->
        <col style="width:155px"><!-- 8 Trait 5 -->
        <col style="width:100px"><!-- 9 Skill -->
        <col style="width:100px"><!-- 10 Activity -->
        <col style="width:75px"> <!-- 11 Fusion -->
        <col style="width:75px"> <!-- 12 Locked -->
        <col style="width:180px"><!-- 13 Notes -->
        <col style="width:45px"> <!-- 14 Del -->
      </colgroup>
      <thead>
        <tr>
          <th data-sort="char">Character</th>
          <th data-sort="name">Deviation Name</th>
          <th data-sort="variant">Variant</th>
          <th>Trait 1</th><th>Trait 2</th><th>Trait 3</th><th>Trait 4</th><th>Trait 5</th>
          <th data-sort="skill">Skill</th>
          <th data-sort="activity">Activity</th>
          <th data-sort="fusion">Fusion</th>
          <th data-sort="locked">Locked</th>
          <th>Notes</th>
          <th>Del</th>
        </tr>
      </thead>
      <tbody id="deviationBody"></tbody>
    </table>
  </div>
</div>

<!-- ======================================================= -->
<!-- TAB 2: FUSION MATERIALS                                  -->
<!-- ======================================================= -->
<div id="tab-fusion" class="tab-content">
  <div class="fm-header">
    <h2>Fusion Pod Materials</h2>
    <p>Track materials available for Fusion. Add anything useful for upgrading or fusing deviations.</p>
  </div>
  <div class="fm-controls">
    <button class="btn btn-primary" onclick="addMaterial()">+ Add Material</button>
  </div>
  <div class="fm-list" id="fmList"></div>
  <p class="fm-empty" id="fmEmpty" style="display:none">No materials added yet. Click Add Material to get started.</p>
</div>

<!-- ======================================================= -->
<!-- SETTINGS SLIDE-IN                                        -->
<!-- ======================================================= -->
<div class="overlay" id="settingsOverlay" onclick="closeSettingsIfBg(event)">
  <div class="settings-panel">
    <div class="settings-header">
      <h2>âš™ Settings</h2>
      <button class="close-btn" onclick="closeSettings()">âœ•</button>
    </div>

    <div class="settings-section">
      <h3>My Characters</h3>
      <div class="char-add-row">
        <input id="charInput" type="text" maxlength="10" placeholder="Character nameâ€¦" onkeydown="if(event.key==='Enter')addChar()" oninput="document.getElementById('charCounter').textContent=this.value.length+'/10'">
        <button class="btn btn-primary" onclick="addChar()">Add</button>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);margin-top:-4px;margin-bottom:6px"><span id="charCounter">0/10</span> characters</div>
      <div class="char-list" id="charList"></div>
      <p class="char-empty" id="charEmpty">No characters added yet. Add one above.</p>
    </div>

    <div class="settings-section">
      <h3>Variants</h3>
      <div class="char-add-row">
        <input id="variantInput" type="text" maxlength="30" placeholder="Variant nameâ€¦" onkeydown="if(event.key==='Enter')addVariant()">
        <button class="btn btn-primary" onclick="addVariant()">Add</button>
      </div>
      <div class="char-list" id="variantList"></div>
      <p class="char-empty" id="variantEmpty">No variants added yet. Add one above.</p>
    </div>

    <div class="settings-section">
      <h3>Data Management</h3>
      <div class="settings-btn-list">
        <button class="btn btn-secondary" onclick="closeSettings();openManageDeviations()">âš¡ Manage Deviations</button>
        <button class="btn btn-secondary" onclick="closeSettings();openManageTraits()">âœ¨ Manage Traits</button>
      </div>
    </div>

    <p class="settings-note">Character names max 10 characters; up to 20 characters. Changes reflect immediately in the tracker.<br><br>Custom deviations and traits are stored in your browser and can be exported via ðŸ’¾ Save Config.</p>
  </div>
</div>

<!-- ======================================================= -->
<!-- MANAGE DEVIATIONS MODAL                                  -->
<!-- ======================================================= -->
<div class="modal-overlay" id="manageDevModal" onclick="closeModalIfBg(event,'manageDevModal')">
  <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="manageDevTitle">
    <div class="modal-header">
      <h3 id="manageDevTitle">âš¡ Manage Deviations</h3>
      <button class="close-btn" onclick="closeModal('manageDevModal')">âœ•</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab-btn active" onclick="switchModalTab('manageDevModal','addDev',this)">Add Deviation</button>
      <button class="modal-tab-btn" onclick="switchModalTab('manageDevModal','removeDev',this)">Remove Deviation</button>
      <button class="modal-tab-btn" onclick="switchModalTab('manageDevModal','editDev',this)">Edit Deviation</button>
    </div>
    <div class="modal-body">
      <!-- Add Deviation -->
      <div class="modal-tab-pane active" data-pane="addDev">
        <div class="form-group">
          <label>Deviation Name</label>
          <input id="newDevName" class="form-input" type="text" placeholder="e.g. Crystal Moth" onkeydown="if(event.key==='Enter')addCustomDeviation()">
        </div>
        <div class="form-group">
          <label>Assign Traits <span style="color:var(--text-muted);font-size:.8em">(optional)</span></label>
          <input class="form-input" id="addDevTraitSearch" type="text" placeholder="Search traitsâ€¦" oninput="filterAddDevTraits()" style="margin-bottom:8px">
          <div style="display:flex;gap:10px">
            <div style="flex:1;min-width:0">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                <span style="font-size:.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.7px">Positive (<span id="addDevPosCount">0</span> selected)</span>
                <div style="display:flex;gap:3px">
                  <button class="btn btn-sm btn-secondary" onclick="selectAllAddDevTraits('pos')">All</button>
                  <button class="btn btn-sm btn-secondary" onclick="clearAllAddDevTraits('pos')">None</button>
                </div>
              </div>
              <div class="dev-checklist" id="addDevPosTraits" style="max-height:200px"></div>
            </div>
            <div style="flex:1;min-width:0">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                <span style="font-size:.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.7px">Negative (<span id="addDevNegCount">0</span> selected)</span>
                <div style="display:flex;gap:3px">
                  <button class="btn btn-sm btn-secondary" onclick="selectAllAddDevTraits('neg')">All</button>
                  <button class="btn btn-sm btn-secondary" onclick="clearAllAddDevTraits('neg')">None</button>
                </div>
              </div>
              <div class="dev-checklist" id="addDevNegTraits" style="max-height:200px"></div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addCustomDeviation()">Add to List</button>
        <div class="flash-msg" id="devAddFlash"></div>
      </div>
      <!-- Remove Deviation -->
      <div class="modal-tab-pane" data-pane="removeDev">
        <div class="remove-search-wrap">
          <input class="mgr-search" id="devRemoveSearch" type="text" placeholder="ðŸ”  Search deviationsâ€¦" oninput="filterDevRemoveList()">
        </div>
        <div class="mgr-list" id="devRemoveList"></div>
      </div>
      <!-- Edit Deviation -->
      <div class="modal-tab-pane" data-pane="editDev">
        <div class="form-group">
          <label>Select Deviation</label>
          <select id="editDevSelect" class="form-input" onchange="loadEditDeviation()">
            <option value="">â€” Select a deviation â€”</option>
          </select>
        </div>
        <div id="editDevPanel" style="display:none">
          <p id="editDevBuiltinNote" style="font-size:.8rem;color:var(--text-muted);margin-bottom:10px"></p>
          <div class="form-group">
            <label>Assigned Traits</label>
            <input class="form-input" id="editDevTraitSearch" type="text" placeholder="Search traitsâ€¦" oninput="filterEditDevTraits()" style="margin-bottom:8px">
            <div style="display:flex;gap:10px">
              <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                  <span style="font-size:.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.7px">Positive (<span id="editDevPosCount">0</span> selected)</span>
                  <div style="display:flex;gap:3px">
                    <button class="btn btn-sm btn-secondary" onclick="selectAllEditDevTraits('pos')">All</button>
                    <button class="btn btn-sm btn-secondary" onclick="clearAllEditDevTraits('pos')">None</button>
                  </div>
                </div>
                <div class="dev-checklist" id="editDevPosTraits" style="max-height:200px"></div>
              </div>
              <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                  <span style="font-size:.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.7px">Negative (<span id="editDevNegCount">0</span> selected)</span>
                  <div style="display:flex;gap:3px">
                    <button class="btn btn-sm btn-secondary" onclick="selectAllEditDevTraits('neg')">All</button>
                    <button class="btn btn-sm btn-secondary" onclick="clearAllEditDevTraits('neg')">None</button>
                  </div>
                </div>
                <div class="dev-checklist" id="editDevNegTraits" style="max-height:200px"></div>
              </div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="saveEditDeviation()">Save Changes</button>
          <div class="flash-msg" id="editDevFlash"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================= -->
<!-- MANAGE TRAITS MODAL                                      -->
<!-- ======================================================= -->
<div class="modal-overlay" id="manageTraitModal" onclick="closeModalIfBg(event,'manageTraitModal')">
  <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="manageTraitTitle">
    <div class="modal-header">
      <h3 id="manageTraitTitle">âœ¨ Manage Traits</h3>
      <button class="close-btn" onclick="closeModal('manageTraitModal')">âœ•</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab-btn active" onclick="switchModalTab('manageTraitModal','addTrait',this)">Add Trait</button>
      <button class="modal-tab-btn" onclick="switchModalTab('manageTraitModal','removeTrait',this)">Remove Trait</button>
    </div>
    <div class="modal-body">
      <!-- Add Trait -->
      <div class="modal-tab-pane active" data-pane="addTrait">
        <div class="form-group">
          <label>Trait Name <span style="color:var(--neg)">*</span></label>
          <input id="newTraitName" class="form-input" type="text" placeholder="Trait name">
        </div>
        <div class="form-group">
          <label>Effect Description <span style="color:var(--neg)">*</span></label>
          <textarea id="newTraitEffect" class="form-textarea" placeholder="Describe the trait effectâ€¦"></textarea>
        </div>
        <div class="form-group">
          <label>Type</label>
          <div class="radio-group">
            <label><input type="radio" name="traitType" value="positive" checked> Positive</label>
            <label><input type="radio" name="traitType" value="negative"> Negative âš </label>
          </div>
        </div>
        <div class="form-group">
          <label>Applies To</label>
          <div class="all-devs-wrap">
            <input type="checkbox" id="traitAllDevs" checked onchange="toggleTraitAppliesTo()">
            <span>All Deviations</span>
          </div>
          <div id="traitDevSelectWrap" style="display:none;margin-top:8px">
            <input class="form-input" id="traitDevSearch" type="text" placeholder="Search deviationsâ€¦" oninput="filterTraitDevChecklist()" style="margin-bottom:6px;border-radius:4px 4px 0 0">
            <div class="dev-checklist" id="traitDevChecklist"></div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addCustomTrait()">Add Trait</button>
        <div class="flash-msg" id="traitAddFlash"></div>
      </div>
      <!-- Remove Trait -->
      <div class="modal-tab-pane" data-pane="removeTrait">
        <div class="remove-search-wrap">
          <input class="mgr-search" id="traitRemoveSearch" type="text" placeholder="ðŸ”  Search traitsâ€¦" oninput="filterTraitRemoveList()">
        </div>
        <div class="mgr-list" id="traitRemoveList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================= -->
<!-- CONFIRM MODAL                                            -->
<!-- ======================================================= -->
<div class="modal-overlay" id="confirmModal" onclick="closeModalIfBg(event,'confirmModal')">
  <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-header">
      <h3 id="confirmTitle">Confirm</h3>
      <button class="close-btn" onclick="closeModal('confirmModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="modal-msg" id="confirmMsg">Are you sure?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
      <button class="btn btn-danger" id="confirmOkBtn">Confirm</button>
    </div>
  </div>
</div>

<footer>Data is saved locally in your browser. Clearing browser data will erase your tracker.</footer>

<!-- SHARED TRAIT TOOLTIP (fixed, body-level, z-index 9999) -->
<div id="shared-tooltip">
  <div id="shared-tooltip-header" class="tooltip-header pos"></div>
  <div id="shared-tooltip-body"   class="tooltip-body"></div>
</div>

<!-- ======================================================= -->
<!-- SCRIPTS                                                  -->
<!-- ======================================================= -->
<script src="config.js"></script>
<script>
'use strict';

/* ============================================================
   STATE & STORAGE
   ============================================================ */
const KEYS = {
  deviations:             'ohdt_deviations',
  materials:              'ohdt_materials',
  settings:               'ohdt_settings',
  customDeviations:       'ohdt_custom_deviations',
  customTraits:           'ohdt_custom_traits',
  customTraitAssignments: 'ohdt_custom_trait_assignments',
};

let state = {
  deviations:             [],
  materials:              [],
  settings:               { characters: [] },
  customDeviations:       [],
  customTraits:           [],
  customTraitAssignments: {},
};

let sortCol = null, sortDir = 1;
let filters = { char:'', deviation:'', fusion:'', locked:'', skill:'', activity:'', variant:'' };
let dragSrcIdx = null;
let confirmCallback = null;

/* â”€â”€ Migration â”€â”€ */
function migrateStorage() {
  const old = localStorage.getItem('ohdt_deviants');
  const cur = localStorage.getItem(KEYS.deviations);
  if (old && !cur) {
    localStorage.setItem(KEYS.deviations, old);
    localStorage.removeItem('ohdt_deviants');
  }
}

function load() {
  migrateStorage();
  const parse = (key, def) => { try { return JSON.parse(localStorage.getItem(KEYS[key])) || def; } catch(e) { return def; } };
  state.deviations             = parse('deviations',             []);
  state.materials              = parse('materials',              []);
  state.settings               = parse('settings',               { characters: [] });
  state.customDeviations       = parse('customDeviations',       []);
  state.customTraits           = parse('customTraits',           []);
  state.customTraitAssignments = parse('customTraitAssignments', {});
  if (!state.settings.characters) state.settings.characters = [];
  if (!state.settings.variants)   state.settings.variants   = [];
  if (!state.customTraitAssignments) state.customTraitAssignments = {};
}

function save(key) {
  localStorage.setItem(KEYS[key], JSON.stringify(state[key]));
}

/* â”€â”€ Data Getters â”€â”€ */
function getAllDeviations() {
  return [...new Set([...DEVIANT_LIST, ...state.customDeviations])].sort((a, b) => a.localeCompare(b));
}

function getAllTraits() {
  const custom = (state.customTraits || []).map(t => ({
    name: t.type === 'negative' ? 'âš  ' + t.name : t.name,
    effect: t.effect,
    deviants: t.deviations,
    neg: t.type === 'negative',
    custom: true,
    rawName: t.name,
    id: t.id,
  }));
  return [...TRAIT_DATA, ...custom];
}

function traitsForDeviation(devName) {
  const all = getAllTraits();
  if (!devName) return all;
  const assign    = (state.customTraitAssignments || {})[devName] || {};
  const addList   = assign.add    || [];
  const rmList    = assign.remove || [];
  // Base: naturally applicable traits
  let result = all.filter(t => t.deviants === 'ALL' || (Array.isArray(t.deviants) && t.deviants.includes(devName)));
  // Add extra traits explicitly assigned
  addList.forEach(name => { if (!result.some(t => t.name === name)) { const found = all.find(t => t.name === name); if (found) result.push(found); } });
  // Remove explicitly removed traits
  result = result.filter(t => !rmList.includes(t.name));
  // Sort: positives first, then negatives
  return result.sort((a, b) => a.neg !== b.neg ? (a.neg ? 1 : -1) : a.name.localeCompare(b.name));
}

/* ============================================================
   MAIN TABS
   ============================================================ */
function switchTab(id, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + id).classList.add('active');
}

/* ============================================================
   MODAL SYSTEM
   ============================================================ */
function openModal(id) {
  const overlay = document.getElementById(id);
  overlay.classList.add('open');
  overlay._lastFocus = document.activeElement;
  const modal = overlay.querySelector('.modal');
  requestAnimationFrame(() => {
    const first = modal.querySelector('button,input,select,textarea,[tabindex]');
    if (first) first.focus();
    setupTrapFocus(modal, id);
  });
}

function closeModal(id) {
  const overlay = document.getElementById(id);
  overlay.classList.remove('open');
  const modal = overlay.querySelector('.modal');
  removeTrapFocus(modal);
  if (overlay._lastFocus) overlay._lastFocus.focus();
}

function closeModalIfBg(e, id) {
  if (e.target === document.getElementById(id)) closeModal(id);
}

function setupTrapFocus(el, modalId) {
  function handler(e) {
    if (e.key === 'Escape') { closeModal(modalId); return; }
    if (e.key !== 'Tab') return;
    const focusable = Array.from(el.querySelectorAll(
      'button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])'
    )).filter(n => {
      let p = n.parentElement;
      while (p) { if (p.style && (p.style.display === 'none' || p.style.visibility === 'hidden')) return false; p = p.parentElement; }
      return true;
    });
    if (!focusable.length) return;
    const first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  }
  el._trapHandler = handler;
  el.addEventListener('keydown', handler);
}

function removeTrapFocus(el) {
  if (el._trapHandler) el.removeEventListener('keydown', el._trapHandler);
}

function switchModalTab(modalId, tabName, btn) {
  const overlay = document.getElementById(modalId);
  overlay.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
  overlay.querySelectorAll('.modal-tab-pane').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  overlay.querySelector(`[data-pane="${tabName}"]`).classList.add('active');
  // Lazy-render/populate when specific tabs are opened
  if (tabName === 'removeDev')   renderDevRemoveList();
  if (tabName === 'removeTrait') renderTraitRemoveList();
  if (tabName === 'editDev') {
    populateEditDevSelect();
    document.getElementById('editDevSelect').value = '';
    document.getElementById('editDevPanel').style.display = 'none';
  }
}

/* Confirm modal */
function showConfirm(title, msg, cb) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent   = msg;
  confirmCallback = cb;
  openModal('confirmModal');
}

document.getElementById('confirmOkBtn').addEventListener('click', () => {
  closeModal('confirmModal');
  if (confirmCallback) { confirmCallback(); confirmCallback = null; }
});

/* Flash message */
let flashTimers = {};
function showFlash(elId, msg, isErr = false) {
  const el = document.getElementById(elId);
  clearTimeout(flashTimers[elId]);
  el.textContent = msg;
  el.className = 'flash-msg show' + (isErr ? ' err' : '');
  flashTimers[elId] = setTimeout(() => { el.classList.remove('show'); }, 2500);
}

/* ============================================================
   SETTINGS
   ============================================================ */
function openSettings()  { document.getElementById('settingsOverlay').classList.add('open'); }
function closeSettings() { document.getElementById('settingsOverlay').classList.remove('open'); }
function closeSettingsIfBg(e) { if (e.target === document.getElementById('settingsOverlay')) closeSettings(); }

function renderCharList() {
  const list  = document.getElementById('charList');
  const empty = document.getElementById('charEmpty');
  const chars = state.settings.characters;
  list.innerHTML = '';
  if (!chars.length) { empty.style.display = ''; return; }
  empty.style.display = 'none';
  chars.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'char-item';
    div.innerHTML = `<span>${escHtml(c)}</span><button class="char-del" onclick="delChar(${i})" title="Remove">âœ•</button>`;
    list.appendChild(div);
  });
  updateAllCharDropdowns();
}

function addChar() {
  const inp = document.getElementById('charInput');
  const val = inp.value.trim().slice(0, 10);
  if (!val) return;
  const chars = state.settings.characters;
  if (chars.includes(val) || chars.length >= 20) { inp.value = ''; return; }
  chars.push(val);
  save('settings');
  renderCharList();
  updateFilterCharDropdown();
  inp.value = '';
}

function delChar(i) {
  state.settings.characters.splice(i, 1);
  save('settings');
  renderCharList();
  updateFilterCharDropdown();
}

function updateAllCharDropdowns() {
  document.querySelectorAll('select.row-char').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">â€”</option>' +
      state.settings.characters.map(c => `<option value="${escHtml(c)}"${c===cur?' selected':''}>${escHtml(c)}</option>`).join('');
  });
}

function updateFilterCharDropdown() {
  const sel = document.getElementById('fChar');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All</option>' +
    state.settings.characters.map(c => `<option value="${escHtml(c)}"${c===cur?' selected':''}>${escHtml(c)}</option>`).join('');
}

/* ============================================================
   VARIANTS
   ============================================================ */
function getAllVariants() {
  return [...(state.settings.variants || [])].sort((a, b) => a.localeCompare(b));
}

function buildVariantOptions(curVal) {
  const variants = getAllVariants();
  let opts = `<option value=""${!curVal?' selected':''}>â€”</option>`;
  variants.forEach(v => opts += `<option value="${escHtml(v)}"${v===curVal?' selected':''}>${escHtml(v)}</option>`);
  opts += `<option value="__add__">âž• Add new variant...</option>`;
  return opts;
}

function renderVariantSelect(rowId, val) {
  return `<select class="row-variant" onchange="rowChange('${rowId}','variant',this.value)">${buildVariantOptions(val)}</select>`;
}

function updateAllVariantDropdowns() {
  document.querySelectorAll('select.row-variant').forEach(sel => {
    const tr    = sel.closest('tr');
    const rowId = tr ? tr.dataset.id : null;
    const row   = rowId ? state.deviations.find(r => String(r.id) === String(rowId)) : null;
    const cur   = row ? row.variant : '';
    sel.innerHTML = buildVariantOptions(cur);
  });
}

function updateFilterVariantDropdown() {
  const sel = document.getElementById('fVariant');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All</option>' +
    getAllVariants().map(v => `<option value="${escHtml(v)}"${v===cur?' selected':''}>${escHtml(v)}</option>`).join('');
}

function renderVariantList() {
  const list  = document.getElementById('variantList');
  const empty = document.getElementById('variantEmpty');
  if (!list) return;
  const variants = state.settings.variants || [];
  list.innerHTML = '';
  if (!variants.length) { empty.style.display = ''; return; }
  empty.style.display = 'none';
  variants.forEach((v, i) => {
    const div = document.createElement('div');
    div.className = 'char-item';
    div.innerHTML = `<span>${escHtml(v)}</span><button class="char-del" onclick="delVariant(${i})" title="Remove">âœ•</button>`;
    list.appendChild(div);
  });
}

function addVariant() {
  const inp = document.getElementById('variantInput');
  const val = inp.value.trim().slice(0, 30);
  if (!val) return;
  const variants = state.settings.variants || (state.settings.variants = []);
  if (variants.some(v => v.toLowerCase() === val.toLowerCase())) { inp.value = ''; return; }
  variants.push(val);
  save('settings');
  renderVariantList();
  updateAllVariantDropdowns();
  updateFilterVariantDropdown();
  inp.value = '';
}

function delVariant(i) {
  state.settings.variants.splice(i, 1);
  save('settings');
  renderVariantList();
  updateAllVariantDropdowns();
  updateFilterVariantDropdown();
}

/* ============================================================
   MANAGE DEVIATIONS
   ============================================================ */
function openManageDeviations() {
  // Reset add tab
  document.getElementById('newDevName').value = '';
  document.getElementById('devAddFlash').className = 'flash-msg';
  document.getElementById('devRemoveSearch').value = '';
  document.getElementById('addDevTraitSearch').value = '';
  renderAddDevTraitLists();
  // Reset edit tab
  document.getElementById('editDevSelect').value = '';
  document.getElementById('editDevPanel').style.display = 'none';
  document.getElementById('editDevTraitSearch').value = '';
  populateEditDevSelect();
  // Reset to Add tab
  const modal = document.getElementById('manageDevModal');
  modal.querySelectorAll('.modal-tab-btn').forEach((b,i) => b.classList.toggle('active', i===0));
  modal.querySelectorAll('.modal-tab-pane').forEach((p,i) => p.classList.toggle('active', i===0));
  openModal('manageDevModal');
}

function addCustomDeviation() {
  const inp = document.getElementById('newDevName');
  const val = inp.value.trim();
  if (!val) { showFlash('devAddFlash', 'âš  Please enter a deviation name.', true); return; }
  const all = getAllDeviations();
  if (all.some(d => d.toLowerCase() === val.toLowerCase())) {
    showFlash('devAddFlash', 'âš  That deviation already exists in the list.', true);
    return;
  }
  state.customDeviations.push(val);
  save('customDeviations');
  // Save trait assignments if any traits were checked
  const checkedTraits = getAddDevCheckedTraits();
  let assignedCount = 0;
  if (checkedTraits.length > 0) {
    if (!state.customTraitAssignments) state.customTraitAssignments = {};
    state.customTraitAssignments[val] = { add: checkedTraits, remove: [] };
    save('customTraitAssignments');
    assignedCount = checkedTraits.length;
  }
  inp.value = '';
  renderAddDevTraitLists();
  const msg = assignedCount > 0
    ? `âœ“ ${val} added with ${assignedCount} trait assignment${assignedCount !== 1 ? 's' : ''}!`
    : 'âœ“ Deviation added!';
  showFlash('devAddFlash', msg);
  // Refresh all deviation dropdowns
  refreshAllDeviationDropdowns();
}

function renderDevRemoveList() {
  const search  = (document.getElementById('devRemoveSearch').value || '').toLowerCase();
  const list    = document.getElementById('devRemoveList');
  const all     = getAllDeviations();
  const visible = all.filter(d => !search || d.toLowerCase().includes(search));
  list.innerHTML = '';
  if (!visible.length) { list.innerHTML = '<div class="mgr-empty">No deviations found.</div>'; return; }
  visible.forEach(name => {
    const isBuiltIn = DEVIANT_LIST.includes(name);
    const div = document.createElement('div');
    div.className = 'mgr-item';
    div.innerHTML = `<span class="mgr-item-name">${escHtml(name)}</span>` + (
      isBuiltIn
        ? `<span class="lock-icon" title="Built-in deviation â€” edit config.js to remove">ðŸ”’</span>`
        : `<button class="mgr-del-btn" onclick="removeCustomDeviation('${escHtml(name).replace(/'/g,"\\'")}')">âœ•</button>`
    );
    list.appendChild(div);
  });
}

function filterDevRemoveList() { renderDevRemoveList(); }

function removeCustomDeviation(name) {
  showConfirm(
    'Remove Deviation',
    `Remove "${name}" from the deviation list? Rows using it will keep the value but it won't appear in future dropdowns.`,
    () => {
      state.customDeviations = state.customDeviations.filter(d => d !== name);
      save('customDeviations');
      renderDevRemoveList();
      refreshAllDeviationDropdowns();
    }
  );
}

function refreshAllDeviationDropdowns() {
  // Re-render visible rows that have deviation dropdowns
  renderTable();
}

/* ============================================================
   TRAIT ASSIGNMENT EDITOR  (Add tab & Edit Deviation tab)
   ============================================================ */

/* â”€â”€ ADD TAB â”€â”€ */
function renderAddDevTraitLists() {
  const allTraits = getAllTraits();
  const pos = allTraits.filter(t => !t.neg);
  const neg = allTraits.filter(t =>  t.neg);
  const makeList = (traits, id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = traits.map(t =>
      `<label class="dev-check-item">
        <input type="checkbox" name="addDevTrait" value="${escHtml(t.name)}" onchange="updateAddDevCounts()">
        ${escHtml(t.name)}
      </label>`
    ).join('');
  };
  makeList(pos, 'addDevPosTraits');
  makeList(neg, 'addDevNegTraits');
  updateAddDevCounts();
}

function filterAddDevTraits() {
  const q = (document.getElementById('addDevTraitSearch').value || '').toLowerCase();
  ['addDevPosTraits','addDevNegTraits'].forEach(cid => {
    document.querySelectorAll(`#${cid} .dev-check-item`).forEach(el => {
      el.classList.toggle('hidden', !!q && !el.textContent.trim().toLowerCase().includes(q));
    });
  });
}

function updateAddDevCounts() {
  const pos = document.querySelectorAll('#addDevPosTraits input[name="addDevTrait"]:checked').length;
  const neg = document.querySelectorAll('#addDevNegTraits input[name="addDevTrait"]:checked').length;
  const pe = document.getElementById('addDevPosCount'); if (pe) pe.textContent = pos;
  const ne = document.getElementById('addDevNegCount'); if (ne) ne.textContent = neg;
}

function selectAllAddDevTraits(type) {
  const cid = type === 'pos' ? 'addDevPosTraits' : 'addDevNegTraits';
  document.querySelectorAll(`#${cid} .dev-check-item:not(.hidden) input`).forEach(cb => cb.checked = true);
  updateAddDevCounts();
}

function clearAllAddDevTraits(type) {
  const cid = type === 'pos' ? 'addDevPosTraits' : 'addDevNegTraits';
  document.querySelectorAll(`#${cid} .dev-check-item:not(.hidden) input`).forEach(cb => cb.checked = false);
  updateAddDevCounts();
}

function getAddDevCheckedTraits() {
  return Array.from(document.querySelectorAll('input[name="addDevTrait"]:checked')).map(cb => cb.value);
}

/* â”€â”€ EDIT TAB â”€â”€ */
function populateEditDevSelect() {
  const sel = document.getElementById('editDevSelect');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Select a deviation â€”</option>' +
    getAllDeviations().map(d => `<option value="${escHtml(d)}"${d===cur?' selected':''}>${escHtml(d)}</option>`).join('');
}

function loadEditDeviation() {
  const devName = document.getElementById('editDevSelect').value;
  const panel   = document.getElementById('editDevPanel');
  if (!devName) { panel.style.display = 'none'; return; }
  const note = document.getElementById('editDevBuiltinNote');
  note.textContent = DEVIANT_LIST.includes(devName)
    ? 'ðŸ”’ Built-in deviation â€” changes stored as overrides, config.js is not modified.'
    : '';
  panel.style.display = 'block';
  document.getElementById('editDevTraitSearch').value = '';
  renderEditDevTraitLists(devName);
}

function renderEditDevTraitLists(devName) {
  const currentNames = traitsForDeviation(devName).map(t => t.name);
  const allTraits = getAllTraits();
  const pos = allTraits.filter(t => !t.neg);
  const neg = allTraits.filter(t =>  t.neg);
  const makeList = (traits, id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = traits.map(t =>
      `<label class="dev-check-item">
        <input type="checkbox" name="editDevTrait" value="${escHtml(t.name)}" ${currentNames.includes(t.name)?'checked':''} onchange="updateEditDevCounts()">
        ${escHtml(t.name)}
      </label>`
    ).join('');
  };
  makeList(pos, 'editDevPosTraits');
  makeList(neg, 'editDevNegTraits');
  updateEditDevCounts();
}

function filterEditDevTraits() {
  const q = (document.getElementById('editDevTraitSearch').value || '').toLowerCase();
  ['editDevPosTraits','editDevNegTraits'].forEach(cid => {
    document.querySelectorAll(`#${cid} .dev-check-item`).forEach(el => {
      el.classList.toggle('hidden', !!q && !el.textContent.trim().toLowerCase().includes(q));
    });
  });
}

function updateEditDevCounts() {
  const pos = document.querySelectorAll('#editDevPosTraits input[name="editDevTrait"]:checked').length;
  const neg = document.querySelectorAll('#editDevNegTraits input[name="editDevTrait"]:checked').length;
  const pe = document.getElementById('editDevPosCount'); if (pe) pe.textContent = pos;
  const ne = document.getElementById('editDevNegCount'); if (ne) ne.textContent = neg;
}

function selectAllEditDevTraits(type) {
  const cid = type === 'pos' ? 'editDevPosTraits' : 'editDevNegTraits';
  document.querySelectorAll(`#${cid} .dev-check-item:not(.hidden) input`).forEach(cb => cb.checked = true);
  updateEditDevCounts();
}

function clearAllEditDevTraits(type) {
  const cid = type === 'pos' ? 'editDevPosTraits' : 'editDevNegTraits';
  document.querySelectorAll(`#${cid} .dev-check-item:not(.hidden) input`).forEach(cb => cb.checked = false);
  updateEditDevCounts();
}

function getEditDevCheckedTraits() {
  return Array.from(document.querySelectorAll('input[name="editDevTrait"]:checked')).map(cb => cb.value);
}

function saveEditDeviation() {
  const devName = document.getElementById('editDevSelect').value;
  if (!devName) return;
  // Baseline: what naturally applies without customTraitAssignments
  const allTraits  = getAllTraits();
  const baseline   = allTraits
    .filter(t => t.deviants === 'ALL' || (Array.isArray(t.deviants) && t.deviants.includes(devName)))
    .map(t => t.name);
  const checked    = getEditDevCheckedTraits();
  const addList    = checked.filter(n => !baseline.includes(n));
  const removeList = baseline.filter(n => !checked.includes(n));
  if (!state.customTraitAssignments) state.customTraitAssignments = {};
  if (addList.length === 0 && removeList.length === 0) {
    delete state.customTraitAssignments[devName];
  } else {
    state.customTraitAssignments[devName] = { add: addList, remove: removeList };
  }
  save('customTraitAssignments');
  refreshTraitDropdownsForDeviation(devName);
  const label = devName.length > 30 ? devName.slice(0, 27) + 'â€¦' : devName;
  showFlash('editDevFlash', `âœ“ Trait assignments updated for ${label}`);
}

function refreshTraitDropdownsForDeviation(devName) {
  const validNames = traitsForDeviation(devName).map(t => t.name);
  state.deviations.forEach(row => {
    if (row.name !== devName) return;
    let changed = false;
    for (let i = 0; i < 5; i++) {
      if (row.traits[i] && !validNames.includes(row.traits[i])) { row.traits[i] = ''; changed = true; }
    }
    if (changed) save('deviations');
    for (let i = 0; i < 5; i++) renderTraitCell(row.id, i, devName, row.traits[i]);
  });
}

/* ============================================================
   MANAGE TRAITS
   ============================================================ */
function openManageTraits() {
  // Reset add tab
  document.getElementById('newTraitName').value   = '';
  document.getElementById('newTraitEffect').value = '';
  document.querySelector('input[name="traitType"][value="positive"]').checked = true;
  document.getElementById('traitAllDevs').checked = true;
  document.getElementById('traitDevSelectWrap').style.display = 'none';
  document.getElementById('traitAddFlash').className = 'flash-msg';
  document.getElementById('traitRemoveSearch').value = '';
  // Reset to Add tab
  const modal = document.getElementById('manageTraitModal');
  modal.querySelectorAll('.modal-tab-btn').forEach((b,i) => b.classList.toggle('active', i===0));
  modal.querySelectorAll('.modal-tab-pane').forEach((p,i) => p.classList.toggle('active', i===0));
  // Populate dev checklist
  renderTraitDevChecklist('');
  openModal('manageTraitModal');
}

function toggleTraitAppliesTo() {
  const all  = document.getElementById('traitAllDevs').checked;
  document.getElementById('traitDevSelectWrap').style.display = all ? 'none' : 'block';
}

function renderTraitDevChecklist(search) {
  const cont = document.getElementById('traitDevChecklist');
  const devs = getAllDeviations();
  cont.innerHTML = devs.map(d => {
    const hide = search && !d.toLowerCase().includes(search.toLowerCase());
    return `<label class="dev-check-item${hide?' hidden':''}">
      <input type="checkbox" name="traitDevPick" value="${escHtml(d)}">
      ${escHtml(d)}
    </label>`;
  }).join('');
}

function filterTraitDevChecklist() {
  const q = document.getElementById('traitDevSearch').value.toLowerCase();
  document.querySelectorAll('#traitDevChecklist .dev-check-item').forEach(el => {
    el.classList.toggle('hidden', !!q && !el.textContent.trim().toLowerCase().includes(q));
  });
}

function addCustomTrait() {
  const name   = document.getElementById('newTraitName').value.trim();
  const effect = document.getElementById('newTraitEffect').value.trim();
  const type   = document.querySelector('input[name="traitType"]:checked').value;
  const allDevs = document.getElementById('traitAllDevs').checked;

  if (!name)   { showFlash('traitAddFlash', 'âš  Trait name is required.',         true); return; }
  if (!effect) { showFlash('traitAddFlash', 'âš  Effect description is required.', true); return; }

  // Check duplicate (compare ignoring âš  prefix)
  const all = getAllTraits();
  const displayName = type === 'negative' ? 'âš  ' + name : name;
  if (all.some(t => t.name.toLowerCase() === displayName.toLowerCase())) {
    showFlash('traitAddFlash', 'âš  A trait with that name already exists.', true);
    return;
  }

  let deviations = 'ALL';
  if (!allDevs) {
    const checked = Array.from(document.querySelectorAll('input[name="traitDevPick"]:checked')).map(el => el.value);
    if (!checked.length) { showFlash('traitAddFlash', 'âš  Select at least one deviation, or choose "All Deviations".', true); return; }
    deviations = checked;
  }

  state.customTraits.push({ id: Date.now() + Math.random(), name, effect, type, deviations });
  save('customTraits');
  document.getElementById('newTraitName').value   = '';
  document.getElementById('newTraitEffect').value = '';
  document.querySelector('input[name="traitType"][value="positive"]').checked = true;
  document.getElementById('traitAllDevs').checked = true;
  document.getElementById('traitDevSelectWrap').style.display = 'none';
  showFlash('traitAddFlash', 'âœ“ Trait added!');
}

function renderTraitRemoveList() {
  const search = (document.getElementById('traitRemoveSearch').value || '').toLowerCase();
  const list   = document.getElementById('traitRemoveList');
  const all    = getAllTraits();
  const pos    = all.filter(t => !t.neg && (!search || t.name.toLowerCase().includes(search)));
  const neg    = all.filter(t =>  t.neg && (!search || t.name.toLowerCase().includes(search)));
  list.innerHTML = '';

  function makeSection(label, traits) {
    if (!traits.length) return;
    const head = document.createElement('div');
    head.className = 'mgr-section-head';
    head.textContent = label;
    list.appendChild(head);
    traits.forEach(t => {
      const isBuiltIn = TRAIT_DATA.some(bt => bt.name === t.name);
      const div = document.createElement('div');
      div.className = 'mgr-item';
      div.innerHTML = `<span class="mgr-item-name${t.neg?' neg-name':''}">${escHtml(t.name)}</span>` + (
        isBuiltIn
          ? `<span class="lock-icon" title="Built-in trait â€” edit config.js to remove">ðŸ”’</span>`
          : `<button class="mgr-del-btn" onclick="removeCustomTrait(${JSON.stringify(t.rawName||t.name)},${JSON.stringify(t.id)})">âœ•</button>`
      );
      list.appendChild(div);
    });
  }

  makeSection('Positive Traits', pos);
  makeSection('âš  Negative Traits', neg);
  if (!pos.length && !neg.length) list.innerHTML = '<div class="mgr-empty">No traits found.</div>';
}

function filterTraitRemoveList() { renderTraitRemoveList(); }

function removeCustomTrait(rawName, id) {
  const displayName = state.customTraits.find(t => t.id === id)?.type === 'negative' ? 'âš  ' + rawName : rawName;
  showConfirm(
    'Remove Trait',
    `Remove "${displayName}"? Rows using it will keep the value but it won't appear in future dropdowns.`,
    () => {
      state.customTraits = state.customTraits.filter(t => t.id !== id);
      save('customTraits');
      renderTraitRemoveList();
    }
  );
}

/* ============================================================
   DEVIATIONS TABLE
   ============================================================ */
function newDeviation() {
  return { id: Date.now() + Math.random(), char:'', name:'', variant:'', traits:['','','','',''], skill:0, activity:0, fusion:false, locked:false, notes:'' };
}

function addDeviationRow() {
  const charFilter = document.getElementById('fChar').value;
  const row = newDeviation();
  if (charFilter) row.char = charFilter;
  state.deviations.push(row);
  save('deviations');
  renderTable();
}

function deleteDeviationRow(id) {
  showConfirm('Delete Deviation', 'Are you sure you want to delete this row?', () => {
    state.deviations = state.deviations.filter(d => String(d.id) !== String(id));
    save('deviations');
    renderTable();
  });
}

function getFilteredSorted() {
  let rows = [...state.deviations];
  const { char, deviation, fusion, locked, skill, activity, variant } = filters;
  if (char)      rows = rows.filter(r => r.char === char);
  if (deviation) rows = rows.filter(r => r.name.toLowerCase().includes(deviation.toLowerCase()));
  if (fusion  !== '') rows = rows.filter(r => (r.fusion ?'1':'0') === fusion);
  if (locked  !== '') rows = rows.filter(r => (r.locked ?'1':'0') === locked);
  if (skill)     rows = rows.filter(r => String(r.skill)    === skill);
  if (activity)  rows = rows.filter(r => String(r.activity) === activity);
  if (variant)   rows = rows.filter(r => r.variant === variant);
  if (sortCol) {
    const k = { char:'char', name:'name', variant:'variant', skill:'skill', activity:'activity', fusion:'fusion', locked:'locked' }[sortCol];
    if (k) rows.sort((a, b) => {
      let av = a[k], bv = b[k];
      if (typeof av === 'boolean') av = av ? 1 : 0;
      if (typeof bv === 'boolean') bv = bv ? 1 : 0;
      return (typeof av === 'number' ? av - bv : String(av).localeCompare(String(bv))) * sortDir;
    });
  }
  return rows;
}

function renderTable() {
  const rows  = getFilteredSorted();
  const tbody = document.getElementById('deviationBody');
  tbody.innerHTML = '';
  const total = state.deviations.length;
  const word  = total === 1 ? 'deviation' : 'deviations';
  document.getElementById('rowCount').textContent = `Showing ${rows.length} of ${total} ${word}`;

  if (rows.length === 0) {
    const tr = document.createElement('tr');
    tr.className = 'empty-row';
    tr.innerHTML = `<td colspan="14">${total === 0 ? 'No deviations added yet. Click <strong>+ Add Deviation</strong> to get started.' : 'No deviations match the current filters.'}</td>`;
    tbody.appendChild(tr);
    return;
  }

  const allDevs = getAllDeviations();

  rows.forEach(row => {
    const tr = document.createElement('tr');
    tr.dataset.id = row.id;

    const charOpts = '<option value="">â€”</option>' + state.settings.characters.map(c => `<option value="${escHtml(c)}"${c===row.char?' selected':''}>${escHtml(c)}</option>`).join('');
    const devOpts  = '<option value="">â€”</option>' + allDevs.map(d => `<option value="${escHtml(d)}"${d===row.name?' selected':''}>${escHtml(d)}</option>`).join('');

    tr.innerHTML = `
      <td><select class="row-char" onchange="rowChange('${row.id}','char',this.value)">${charOpts}</select></td>
      <td><select class="row-name" onchange="rowChange('${row.id}','name',this.value)">${devOpts}</select></td>
      <td>${renderVariantSelect(row.id, row.variant)}</td>
      <td class="trait-cell" id="tc_${row.id}_0"></td>
      <td class="trait-cell" id="tc_${row.id}_1"></td>
      <td class="trait-cell" id="tc_${row.id}_2"></td>
      <td class="trait-cell" id="tc_${row.id}_3"></td>
      <td class="trait-cell" id="tc_${row.id}_4"></td>
      <td>${renderSkillSelect(row.id, row.skill)}</td>
      <td>${renderActivitySelect(row.id, row.activity)}</td>
      <td class="toggle-wrap"><label class="toggle"><input type="checkbox" ${row.fusion?'checked':''} onchange="rowChange('${row.id}','fusion',this.checked)"><span class="toggle-slider"></span></label></td>
      <td class="toggle-wrap"><label class="toggle"><input type="checkbox" ${row.locked?'checked':''} onchange="rowChange('${row.id}','locked',this.checked)"><span class="toggle-slider"></span></label></td>
      <td><input type="text" value="${escHtml(row.notes)}" placeholder="Notesâ€¦" oninput="rowChange('${row.id}','notes',this.value)"></td>
      <td style="text-align:center"><button class="del-btn" onclick="deleteDeviationRow('${row.id}')">âœ•</button></td>
    `;
    tbody.appendChild(tr);

    for (let i = 0; i < 5; i++) renderTraitCell(row.id, i, row.name, row.traits[i]);
  });

  // Sort arrows
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.classList.remove('sort-asc', 'sort-desc');
    if (th.dataset.sort === sortCol) th.classList.add(sortDir === 1 ? 'sort-asc' : 'sort-desc');
  });
}

function renderSkillSelect(rowId, val) {
  const v = val ? String(val) : '';
  return `<select onchange="rowChange('${rowId}','skill',this.value)">
    <option value=""${!v?' selected':''}>â€” Skill â€”</option>
    <option value="1"${v==='1'?' selected':''}>1</option>
    <option value="2"${v==='2'?' selected':''}>2</option>
    <option value="3"${v==='3'?' selected':''}>3</option>
    <option value="4"${v==='4'?' selected':''}>4</option>
    <option value="5"${v==='5'?' selected':''}>5</option>
  </select>`;
}

function renderActivitySelect(rowId, val) {
  const v = val ? String(val) : '';
  return `<select onchange="rowChange('${rowId}','activity',this.value)">
    <option value=""${!v?' selected':''}>â€” Activity â€”</option>
    <option value="1"${v==='1'?' selected':''}>1</option>
    <option value="2"${v==='2'?' selected':''}>2</option>
    <option value="3"${v==='3'?' selected':''}>3</option>
    <option value="4"${v==='4'?' selected':''}>4</option>
    <option value="5"${v==='5'?' selected':''}>5</option>
  </select>`;
}

function renderTraitCell(rowId, slotIdx, devName, curTrait) {
  const cell = document.getElementById(`tc_${rowId}_${slotIdx}`);
  if (!cell) return;
  const avail    = traitsForDeviation(devName);
  const traitDef = getAllTraits().find(t => t.name === curTrait);
  const isNeg    = traitDef?.neg || false;

  let opts = '<option value="">â€”</option>';
  avail.forEach(t => opts += `<option value="${escHtml(t.name)}"${t.name===curTrait?' selected':''}>${escHtml(t.name)}</option>`);

  cell.innerHTML = `<select class="${isNeg?'neg-trait':''}" onchange="traitChange('${rowId}',${slotIdx},this.value)">${opts}</select>`;

  // Attach tooltip via mouse events if a trait is selected
  if (curTrait && traitDef) {
    const sel = cell.querySelector('select');
    sel.addEventListener('mouseenter', () => showTraitTooltip(sel, curTrait, traitDef.effect, isNeg));
    sel.addEventListener('mouseleave', hideTraitTooltip);
    sel.addEventListener('focus',      () => showTraitTooltip(sel, curTrait, traitDef.effect, isNeg));
    sel.addEventListener('blur',       hideTraitTooltip);
  }
}

function rowChange(id, field, val) {
  const row = state.deviations.find(r => String(r.id) === String(id));
  if (!row) return;
  if (field === 'name') {
    row.name = val;
    for (let i = 0; i < 5; i++) {
      if (row.traits[i]) {
        const td = TRAIT_DATA.find(t => t.name === row.traits[i]);
        const ct = (state.customTraits || []).find(t => {
          const dn = t.type==='negative'?'âš  '+t.name:t.name;
          return dn === row.traits[i];
        });
        const anyDef = td || (ct ? {deviants: ct.deviations} : null);
        if (anyDef && anyDef.deviants !== 'ALL' && Array.isArray(anyDef.deviants) && !anyDef.deviants.includes(val)) {
          row.traits[i] = '';
        }
      }
      renderTraitCell(id, i, val, row.traits[i]);
    }
  } else if (field === 'char')     row.char     = val;
  else if (field === 'variant') {
    if (val === '__add__') {
      const nv = window.prompt('Enter new variant name:');
      if (nv && nv.trim()) {
        const trimmed = nv.trim().slice(0, 30);
        const variants = state.settings.variants || (state.settings.variants = []);
        if (!variants.some(v => v.toLowerCase() === trimmed.toLowerCase())) {
          variants.push(trimmed);
          save('settings');
          renderVariantList();
          updateFilterVariantDropdown();
        }
        row.variant = trimmed;
        updateAllVariantDropdowns();
      } else {
        updateAllVariantDropdowns();
        return;
      }
    } else {
      row.variant = val;
    }
  }
  else if (field === 'skill')      row.skill    = val ? Number(val) : 0;
  else if (field === 'activity')   row.activity = val ? Number(val) : 0;
  else if (field === 'fusion')     row.fusion   = val;
  else if (field === 'locked')     row.locked   = val;
  else if (field === 'notes')      row.notes    = val;
  save('deviations');
}

function traitChange(rowId, slotIdx, val) {
  const row = state.deviations.find(r => String(r.id) === String(rowId));
  if (!row) return;
  row.traits[slotIdx] = val;
  save('deviations');
  renderTraitCell(rowId, slotIdx, row.name, val);
}

/* â”€â”€ Trait Tooltip â”€â”€ */
function showTraitTooltip(el, name, effect, isNeg) {
  const tip    = document.getElementById('shared-tooltip');
  const header = document.getElementById('shared-tooltip-header');
  const body   = document.getElementById('shared-tooltip-body');
  header.textContent = name;
  header.className   = 'tooltip-header ' + (isNeg ? 'neg' : 'pos');
  body.textContent   = effect;
  tip.style.display  = 'block';
  // Measure after making visible
  const rect = el.getBoundingClientRect();
  const th   = tip.offsetHeight || 100;
  const tw   = tip.offsetWidth  || 260;
  // Left: clamp so it doesn't overflow right edge
  const left = Math.max(4, Math.min(rect.left, window.innerWidth - tw - 8));
  tip.style.left = left + 'px';
  // Vertical: prefer above, fall back to below
  if (rect.top >= th + 10) {
    tip.style.top    = (rect.top - th - 8) + 'px';
  } else {
    tip.style.top    = Math.min(rect.bottom + 8, window.innerHeight - th - 4) + 'px';
  }
}

function hideTraitTooltip() {
  document.getElementById('shared-tooltip').style.display = 'none';
}

/* â”€â”€ Sort / Filter â”€â”€ */
document.querySelectorAll('th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (sortCol === col) sortDir = -sortDir;
    else { sortCol = col; sortDir = 1; }
    renderTable();
  });
});

function applyFilters() {
  filters.char      = document.getElementById('fChar').value;
  filters.deviation = document.getElementById('fDeviation').value;
  filters.fusion    = document.getElementById('fFusion').value;
  filters.locked    = document.getElementById('fLocked').value;
  filters.skill     = document.getElementById('fSkill').value;
  filters.activity  = document.getElementById('fActivity').value;
  filters.variant   = document.getElementById('fVariant').value;
  renderTable();
}

function clearFilters() {
  ['fChar','fFusion','fLocked','fSkill','fActivity','fVariant'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('fDeviation').value = '';
  filters = { char:'', deviation:'', fusion:'', locked:'', skill:'', activity:'', variant:'' };
  renderTable();
}

/* ============================================================
   EXPORT CSV
   ============================================================ */
function exportCSV() {
  const rows   = getFilteredSorted();
  const header = ['Character','Deviation Name','Variant','Trait 1','Trait 2','Trait 3','Trait 4','Trait 5','Skill Level','Activity Level','Fusion','Locked','Notes'];
  const lines  = [header.map(csvEsc).join(',')];
  rows.forEach(r => lines.push([
    r.char, r.name, r.variant,
    r.traits[0]||'', r.traits[1]||'', r.traits[2]||'', r.traits[3]||'', r.traits[4]||'',
    r.skill, r.activity, r.fusion?'Yes':'No', r.locked?'Yes':'No', r.notes,
  ].map(csvEsc).join(',')));
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'once-human-deviations.csv';
  a.click();
}
function csvEsc(v) { v = String(v||''); return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v; }

/* ============================================================
   CLEAR ALL DATA
   ============================================================ */
function confirmClearAll() {
  showConfirm(
    'ðŸ—‘ Clear All Data',
    'This will permanently delete ALL deviation and material data. Custom deviations and traits are kept. This cannot be undone.',
    () => {
      state.deviations = []; state.materials = [];
      save('deviations'); save('materials');
      renderTable(); renderMaterials();
    }
  );
}

/* ============================================================
   SAVE / LOAD CONFIG
   ============================================================ */
function saveConfig() {
  const data = {
    version:                2,
    customDeviations:       state.customDeviations,
    customTraits:           state.customTraits,
    settings:               state.settings,
    customTraitAssignments: state.customTraitAssignments || {},
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'once-human-tracker-config.json';
  a.click();
}

function triggerLoadConfig() {
  document.getElementById('configFileInput').click();
}

function handleConfigLoad(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.customDeviations)       { state.customDeviations       = data.customDeviations;       save('customDeviations'); }
      if (data.customTraits)           { state.customTraits           = data.customTraits;           save('customTraits'); }
      if (data.settings)               { state.settings               = data.settings;               save('settings'); }
      if (data.customTraitAssignments) { state.customTraitAssignments = data.customTraitAssignments; save('customTraitAssignments'); }
      renderCharList();
      updateFilterCharDropdown();
      renderVariantList();
      updateFilterVariantDropdown();
      renderTable();
      alert('Config loaded successfully.');
    } catch (err) {
      alert('Invalid config file. Please load a valid JSON config.');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

/* ============================================================
   FUSION MATERIALS
   ============================================================ */
function addMaterial() {
  state.materials.push({ id: Date.now() + Math.random(), name:'', qty:0, notes:'' });
  save('materials');
  renderMaterials();
}

function delMaterial(id) {
  state.materials = state.materials.filter(m => String(m.id) !== String(id));
  save('materials');
  renderMaterials();
}

function matChange(id, field, val) {
  const m = state.materials.find(m => String(m.id) === String(id));
  if (!m) return;
  m[field] = field === 'qty' ? Math.max(0, Number(val) || 0) : val;
  save('materials');
}

function renderMaterials() {
  const list  = document.getElementById('fmList');
  const empty = document.getElementById('fmEmpty');
  list.innerHTML = '';
  if (!state.materials.length) { empty.style.display = ''; return; }
  empty.style.display = 'none';
  state.materials.forEach((m, idx) => {
    const div = document.createElement('div');
    div.className = 'fm-row';
    div.draggable = true;
    div.dataset.idx = idx;
    div.innerHTML = `
      <span class="drag-handle" title="Drag to reorder">â ¿</span>
      <input class="fm-input fm-name"  type="text"   value="${escHtml(m.name)}"  placeholder="Material nameâ€¦"  oninput="matChange('${m.id}','name',this.value)">
      <input class="fm-input fm-qty"   type="number" value="${m.qty}"            placeholder="Qty" min="0"     oninput="matChange('${m.id}','qty',this.value)">
      <input class="fm-input fm-notes" type="text"   value="${escHtml(m.notes)}" placeholder="Notesâ€¦"          oninput="matChange('${m.id}','notes',this.value)">
      <button class="del-btn" onclick="delMaterial('${m.id}')">âœ•</button>
    `;
    div.addEventListener('dragstart', e => { dragSrcIdx = idx; setTimeout(() => div.classList.add('dragging'), 0); e.dataTransfer.effectAllowed = 'move'; });
    div.addEventListener('dragend',   () => { div.classList.remove('dragging'); document.querySelectorAll('.fm-row').forEach(r => r.classList.remove('drag-over')); });
    div.addEventListener('dragover',  e => { e.preventDefault(); div.classList.add('drag-over'); });
    div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
    div.addEventListener('drop', e => {
      e.preventDefault(); div.classList.remove('drag-over');
      const tgtIdx = Number(div.dataset.idx);
      if (dragSrcIdx === null || dragSrcIdx === tgtIdx) return;
      const moved = state.materials.splice(dragSrcIdx, 1)[0];
      state.materials.splice(tgtIdx, 0, moved);
      dragSrcIdx = null;
      save('materials');
      renderMaterials();
    });
    list.appendChild(div);
  });
}

/* ============================================================
   GLOBAL KEYBOARD HANDLER
   ============================================================ */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    ['manageDevModal','manageTraitModal','confirmModal'].forEach(id => {
      if (document.getElementById(id).classList.contains('open')) closeModal(id);
    });
    if (document.getElementById('settingsOverlay').classList.contains('open')) closeSettings();
  }
});

/* ============================================================
   UTILS
   ============================================================ */
function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ============================================================
   INIT
   ============================================================ */
load();
renderCharList();
updateFilterCharDropdown();
renderVariantList();
updateFilterVariantDropdown();
renderTable();
renderMaterials();
</script>
</body>
</html>
